---
import { createServerClient, type CookieOptions } from "@supabase/ssr";
import { Database } from '@/types/supabase';
import Layout from "@/layout/layout.astro";
import Form from "@/components/form/Login.vue";

const $supabase = createServerClient<Database>(
	import.meta.env.PUBLIC_SUPABASE_URL,
	import.meta.env.PUBLIC_SUPABASE_KEY,
	{
		cookies: {
			get(key: string) {
				return Astro.cookies.get(key)?.value;
			},
			set(key: string, value: string, options: CookieOptions) {
				Astro.cookies.set(key, value, options);
			},
			remove(key: string, options) {
				Astro.cookies.delete(key, options);
			},
		},
	}
);

const refreshToken = Astro.cookies.get('refresh-token')?.value;
const accessToken = Astro.cookies.get('access-token')?.value;

if (refreshToken && accessToken) {
	await $supabase.auth.setSession({
		refresh_token: refreshToken,
		access_token: accessToken,
	})
}

const {
	data: { user },
} = await $supabase.auth.getUser();

if (user) {
	return Astro.redirect("/");
}
---

<Layout title="Zure Memes">
	<div class="layout">
		<Form client:only="vue" />
	</div>
</Layout>

<style lang="postcss">
	.layout {
		display: grid;
		min-height: 100vh;
		min-height: 100dvh;
		place-content: center;
		gap: 1rem 0;
	}
</style>
